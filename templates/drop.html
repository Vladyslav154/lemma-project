{% extends "base.html" %}

{% block content %}
<div class="form-container">
    <div id="upload-container">
        <h1>{{ t('drop_page_title') }}</h1>
        <p>{{ t('drop_page_subtitle') }}</p>
        <div id="drop-zone">
            <p>{{ t('drop_zone_text') }}</p>
            <input type="file" id="file-input" hidden>
        </div>
        <div id="progress-container" class="hidden">
            <p>{{ t('uploading_text') }}</p>
        </div>
    </div>
    <div id="result-container" class="hidden">
        <h2>{{ t('ready_text') }}</h2>
        <div class="link-wrapper">
            <input type="text" id="download-link" readonly>
            <button id="copy-button" class="button">{{ t('copy_button') }}</button>
        </div>
        <p class="small-text" style="font-size: 0.8rem; opacity: 0.7;">{{ t('one_time_link_text') }}</p>
        <a href="/drop?lang={{ lang }}" style="margin-top: 1rem; display: inline-block;">{{ t('send_another_file') }}</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadContainer = document.getElementById('upload-container');
    const resultContainer = document.getElementById('result-container');
    const downloadLinkInput = document.getElementById('download-link');
    const copyButton = document.getElementById('copy-button');
    const progressContainer = document.getElementById('progress-container');
    
    // Безопасно получаем тексты для кнопки
    const originalCopyText = copyButton ? copyButton.textContent : 'Copy';
    const copiedText = "{{ t('copied_button') }}";

    if (!dropZone) return; // Если мы не на той странице, выходим

    dropZone.addEventListener('click', () => fileInput.click());

    function handleFile(file) {
        uploadContainer.style.display = 'none';
        progressContainer.classList.remove('hidden');
        resultContainer.classList.add('hidden');

        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                // Попытаемся получить текст ошибки от сервера
                return response.json().then(err => { throw new Error(err.detail || 'Network response was not ok'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.download_link) {
                progressContainer.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                downloadLinkInput.value = data.download_link;
            } else {
                throw new Error(data.detail || 'Failed to get link.');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка: ' + error.message);
            // Возвращаем исходный вид
            uploadContainer.style.display = 'block';
            progressContainer.classList.add('hidden');
        });
    }

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            handleFile(fileInput.files[0]);
        }
    });
    
    copyButton.addEventListener('click', () => {
        downloadLinkInput.select();
        document.execCommand('copy');
        copyButton.textContent = copiedText;
        setTimeout(() => {
            copyButton.textContent = originalCopyText;
        }, 2000);
    });
});
</script>
{% endblock %}