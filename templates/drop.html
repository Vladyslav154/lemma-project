{% extends "base.html" %}

{% block content %}
<div class="form-container">
    <div id="upload-container">
        <h1>{{ t('drop_page_title') }}</h1>
        <p>{{ t('drop_page_subtitle') }}</p>
        <div id="drop-zone">
            <p>{{ t('drop_zone_text') }}</p>
            <input type="file" id="file-input" hidden>
        </div>
        <div id="progress-container" class="hidden">
            <p>{{ t('uploading_text') }}</p>
        </div>
    </div>
    <div id="result-container" class="hidden">
        <h2>{{ t('ready_text') }}</h2>

        <div id="qrcode-container">
            <div id="qrcode"></div>
        </div>

        <div class="link-wrapper">
            <input type="text" id="download-link" readonly>
            <button id="copy-button" class="button">{{ t('copy_button') }}</button>
        </div>
        <p class="small-text">{{ t('one_time_link_text') }}</p>
        <a href="/drop?lang={{ lang }}" class="send-another-link">{{ t('send_another_file') }}</a>
    </div>
</div>

<style>
    #qrcode-container {
        margin: 1.5rem auto;
        padding: 1rem;
        background: #ffffff;
        border-radius: 8px;
        display: inline-block;
    }
    .small-text {
        font-size: 0.8rem;
        opacity: 0.7;
    }
    .send-another-link {
        margin-top: 1rem;
        display: inline-block;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadContainer = document.getElementById('upload-container');
    const resultContainer = document.getElementById('result-container');
    const downloadLinkInput = document.getElementById('download-link');
    const copyButton = document.getElementById('copy-button');
    const progressContainer = document.getElementById('progress-container');
    const qrcodeContainer = document.getElementById('qrcode');
    
    if (!dropZone) return;

    const originalCopyText = copyButton.textContent;
    const copiedText = "{{ t('copied_button') }}";

    function handleFile(file) {
        uploadContainer.style.display = 'none';
        progressContainer.classList.remove('hidden');
        resultContainer.classList.add('hidden');

        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.detail || 'Server error'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.download_link) {
                progressContainer.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                downloadLinkInput.value = data.download_link;

                // Генерируем QR-код
                qrcodeContainer.innerHTML = ""; // Очищаем предыдущий код
                new QRCode(qrcodeContainer, {
                    text: data.download_link,
                    width: 128,
                    height: 128,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

            } else {
                throw new Error(data.detail || 'Failed to get link.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
            uploadContainer.style.display = 'block';
            progressContainer.classList.add('hidden');
        });
    }

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', () => { if (fileInput.files.length > 0) handleFile(fileInput.files[0]); });
    
    copyButton.addEventListener('click', () => {
        downloadLinkInput.select();
        document.execCommand('copy');
        copyButton.textContent = copiedText;
        setTimeout(() => { copyButton.textContent = originalCopyText; }, 2000);
    });
});
</script>
{% endblock %}