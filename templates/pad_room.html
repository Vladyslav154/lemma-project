{% extends "base.html" %}

{% block content %}
<div id="password-overlay">
    <div class="form-container" id="password-box">
        <h1 id="password-title"></h1>
        <p id="password-subtitle"></p>
        <div class="chat-form">
            <input type="password" id="password-input" placeholder="{{ t('password_placeholder') }}">
            <button id="password-button" class="button">{{ t('enter_button') }}</button>
        </div>
        <p id="password-error" class="error-message hidden"></p>
    </div>
</div>

<div id="chat-container" class="hidden">
    <div class="form-container">
        <h1>{{ t('pad_page_title') }}</h1>
        <p>{{ t('pad_room_subtitle') }} <strong>{{ room_id }}</strong></p>
        <p class="disclaimer">{{ t('pad_disclaimer') }}</p>
        <div id="chat-box" class="chat-box"></div>
        <form id="message-form" class="chat-form">
            <textarea id="message-input" placeholder="{{ t('message_placeholder') }}" rows="1"></textarea>
            <button id="send-button" type="submit" class="button">➤</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordBox = document.getElementById('password-box');
        const passwordTitle = document.getElementById('password-title');
        const passwordSubtitle = document.getElementById('password-subtitle');
        const passwordInput = document.getElementById('password-input');
        const passwordButton = document.getElementById('password-button');
        const passwordError = document.getElementById('password-error');
        const chatContainer = document.getElementById('chat-container');
        const chatBox = document.getElementById('chat-box');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const roomId = "{{ room_id }}";
        const lang = "{{ lang }}";
        let ws;

        const connect = () => {
            const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${window.location.host}/ws/${roomId}`);

            ws.onopen = () => {
                console.log("WebSocket connected");
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'auth_required') {
                    passwordOverlay.classList.remove('hidden');
                    if (data.action === 'set') {
                        passwordTitle.textContent = "{{ t('password_set_title') }}";
                        passwordSubtitle.textContent = "{{ t('password_set_subtitle') }}";
                    } else {
                        passwordTitle.textContent = "{{ t('password_enter_title') }}";
                        passwordSubtitle.textContent = "{{ t('password_enter_subtitle') }}";
                    }
                } else if (data.type === 'auth_success') {
                    passwordOverlay.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                } else if (data.type === 'auth_fail') {
                    passwordError.textContent = "Неверный пароль.";
                    passwordError.classList.remove('hidden');
                    passwordInput.focus();
                } else {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('chat-message', 'other-message');
                    messageElement.textContent = data.message;
                    chatBox.appendChild(messageElement);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            };

            ws.onclose = () => {
                console.log("WebSocket disconnected");
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
            };
        };

        const authenticate = () => {
            const password = passwordInput.value;
            if (password && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'auth', password: password }));
                passwordError.classList.add('hidden');
            }
        };

        passwordButton.addEventListener('click', authenticate);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                authenticate();
            }
        });

        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value;
            if (message && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ message: message }));

                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message', 'my-message');
                messageElement.textContent = message;
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight;

                messageInput.value = '';
                messageInput.focus();
            }
        });

        connect();
    });
</script>
{% endblock %}