{% extends "base.html" %}

{% block content %}
<div class="form-container">
    <h1>Анонимный чат</h1>
    <p>Вы в комнате: <strong>{{ room_id }}</strong>. Сообщения исчезают. Ничего не сохраняется.</p>
    
    <div id="messages" class="chat-box"></div>

    <form id="message-form" class="chat-form">
        <input type="text" id="message-input" placeholder="Введите сообщение..." autocomplete="off">
        <div class="lifetime-controls">
            <button type="button" class="lifetime-btn active" data-lifetime="10">10с</button>
            <button type="button" class="lifetime-btn" data-lifetime="30">30с</button>
            <button type="button" class="lifetime-btn" data-lifetime="120">2м</button>
        </div>
        <button type="submit" id="send-button">»</button>
    </form>
</div>

<style>
    .chat-box {
        width: 100%;
        height: 60vh;
        margin-top: 1rem;
        background-color: rgba(0,0,0,0.2);
        border: 1px solid var(--border-color-glass);
        border-radius: 15px;
        padding: 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .chat-message {
        background: var(--surface-color-glass);
        padding: 0.5rem 1rem;
        border-radius: 10px;
        max-width: 80%;
        word-wrap: break-word;
        align-self: flex-start;
        text-align: left;
        animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .chat-form {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    #message-input {
        flex-grow: 1;
    }
    #send-button {
        background: var(--primary-color);
        border: none;
        color: #000;
        font-weight: bold;
        font-size: 1.5rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    #send-button:hover {
        transform: scale(1.1);
    }
    .lifetime-controls {
        display: flex;
        background: rgba(0,0,0,0.2);
        border-radius: 25px;
        padding: 4px;
    }
    .lifetime-btn {
        background: transparent;
        border: none;
        color: var(--text-color);
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-radius: 20px;
        font-weight: bold;
    }
    .lifetime-btn.active {
        background: var(--primary-color);
        color: #000;
    }
</style>

<script>
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('messages');
    const lifetimeControls = document.querySelector('.lifetime-controls');
    let selectedLifetime = 10; // Значение по умолчанию

    const room_id = "{{ room_id }}";
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/${room_id}`;
    const socket = new WebSocket(wsUrl);

    // --- Логика для кнопок времени жизни ---
    lifetimeControls.addEventListener('click', (e) => {
        if (e.target.classList.contains('lifetime-btn')) {
            // Убираем класс 'active' у всех кнопок
            lifetimeControls.querySelectorAll('.lifetime-btn').forEach(btn => btn.classList.remove('active'));
            // Добавляем класс 'active' нажатой кнопке
            e.target.classList.add('active');
            // Сохраняем выбранное значение
            selectedLifetime = parseInt(e.target.dataset.lifetime, 10);
        }
    });

    // --- Обработка отправки формы ---
    messageForm.onsubmit = function(event) {
        event.preventDefault();
        const messageText = messageInput.value;
        if (messageText.trim() === '') return;

        // Создаем JSON-объект для отправки
        const messageData = {
            text: messageText,
            lifetime: selectedLifetime
        };

        // Отправляем JSON как строку
        socket.send(JSON.stringify(messageData));
        messageInput.value = ''; // Очищаем поле ввода
    };

    // --- Обработка входящих сообщений ---
    socket.onmessage = function(event) {
        // Парсим JSON из строки
        const messageData = JSON.parse(event.data);
        
        // Создаем HTML-элемент для нового сообщения
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message');
        messageElement.textContent = messageData.text;

        // Добавляем сообщение в контейнер
        messagesContainer.appendChild(messageElement);
        // Прокручиваем вниз
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Устанавливаем таймер на удаление сообщения
        setTimeout(() => {
            messageElement.style.transition = 'opacity 0.5s ease';
            messageElement.style.opacity = '0';
            setTimeout(() => messageElement.remove(), 500); // Удаляем из DOM после анимации
        }, messageData.lifetime * 1000);
    };

</script>
{% endblock %}